<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Test Data Sync System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0b;
            color: #e5e5e5;
            padding: 20px;
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #4a9eff; margin-bottom: 20px; }
        h2 { color: #22c55e; margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid #404044; padding-bottom: 10px; }
        
        .test-section {
            background: #1a1a1b;
            border: 1px solid #404044;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .test-button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            font-family: inherit;
            font-weight: bold;
        }
        
        .test-button:hover { background: #3a8ee0; }
        .test-button:active { transform: scale(0.98); }
        
        .test-button.danger { background: #ff6b6b; }
        .test-button.danger:hover { background: #ee5a5a; }
        
        .test-button.warning { background: #ffa500; }
        .test-button.warning:hover { background: #ff9500; }
        
        .output {
            background: #0a0a0b;
            border: 1px solid #404044;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        
        .log-info { color: #a8a8a8; }
        .log-success { color: #22c55e; }
        .log-warning { color: #ffa500; }
        .log-error { color: #ff6b6b; }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .status-ok { background: #22c55e; color: #000; }
        .status-error { background: #ff6b6b; color: #fff; }
        .status-warning { background: #ffa500; color: #000; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Data Sync System - SAMS v1.15.0+</h1>
        
        <div class="test-section">
            <h2>üìä Status G√©n√©ral</h2>
            <div>
                <span id="dbStatus" class="status status-warning">V√©rification...</span>
                <span id="initStatus" class="status status-warning">Initialisation...</span>
            </div>
            <div style="margin-top: 15px;">
                <button class="test-button" onclick="checkStatus()">V√©rifier Status</button>
                <button class="test-button" onclick="displaySystemInfo()">Info Syst√®me</button>
            </div>
            <div id="statusOutput" class="output"></div>
        </div>
        
        <div class="grid">
            <div class="test-section">
                <h2>üîÑ Chargement</h2>
                <button class="test-button" onclick="testLoadManuels()">Tester Manuels</button>
                <button class="test-button" onclick="testLoadGrades()">Tester Grades</button>
                <button class="test-button" onclick="testLoadSpecialites()">Tester Sp√©cialit√©s</button>
                <button class="test-button" onclick="testLoadCategories()">Tester Cat√©gories</button>
                <button class="test-button" onclick="testLoadBlippers()">Tester Blippers</button>
                <button class="test-button" onclick="testLoadAll()">Charger TOUT</button>
                <div id="loadOutput" class="output"></div>
            </div>
            
            <div class="test-section">
                <h2>üíæ Sauvegarde</h2>
                <button class="test-button warning" onclick="testSaveManuels()">Sauvegarder Test</button>
                <button class="test-button warning" onclick="testSaveToAllSources()">Sauvegarder Partout</button>
                <button class="test-button warning" onclick="testLocalStorage()">Tester LocalStorage</button>
                <button class="test-button danger" onclick="clearAllCache()">üóëÔ∏è Effacer Cache</button>
                <div id="saveOutput" class="output"></div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üß† Cache & Performance</h2>
            <button class="test-button" onclick="viewCache()">Voir Cache</button>
            <button class="test-button" onclick="viewLocalStorage()">Voir LocalStorage</button>
            <button class="test-button" onclick="benchmarkLoad()">Benchmark Load</button>
            <div id="cacheOutput" class="output"></div>
        </div>
        
        <div class="test-section">
            <h2>üîå Connexion BDD</h2>
            <button class="test-button" onclick="testDBConnection()">Tester Connexion</button>
            <button class="test-button" onclick="testDBLoad()">Charger depuis BDD</button>
            <button class="test-button" onclick="testDBSave()">Sauvegarder en BDD</button>
            <div id="dbOutput" class="output"></div>
        </div>
        
        <div class="test-section">
            <h2>üìÑ Fichiers JSON</h2>
            <button class="test-button" onclick="testJSONFiles()">V√©rifier Fichiers</button>
            <button class="test-button" onclick="loadJSONDirect()">Charger JSON Direct</button>
            <div id="jsonOutput" class="output"></div>
        </div>
    </div>

    <script src="js/data-sync.js"></script>
    <script src="js/app-initializer.js"></script>
    
    <script>
        // Utilitaires
        function log(id, message, type = 'info') {
            const output = document.getElementById(id);
            const timestamp = new Date().toLocaleTimeString();
            const className = `log-${type}`;
            output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }
        
        function clear(id) {
            document.getElementById(id).innerHTML = '';
        }

        // Status
        async function checkStatus() {
            clear('statusOutput');
            log('statusOutput', 'üîç V√©rification du statut...', 'info');
            
            const dbStatus = dataSyncManager.dbAvailable;
            const initReady = window.appInitializer?.ready;
            const cacheSize = Object.keys(dataSyncManager.cache).length;
            
            log('statusOutput', `BDD Disponible: ${dbStatus ? '‚úÖ' : '‚ùå'}`, dbStatus ? 'success' : 'error');
            log('statusOutput', `Application Initialis√©e: ${initReady ? '‚úÖ' : '‚ùå'}`, initReady ? 'success' : 'warning');
            log('statusOutput', `Items en Cache: ${cacheSize}`, 'info');
            
            if (initReady) {
                const data = appInitializer.getStatus();
                log('statusOutput', JSON.stringify(data, null, 2), 'info');
            }
        }

        function displaySystemInfo() {
            clear('statusOutput');
            log('statusOutput', 'üíª Informations Syst√®me:', 'info');
            log('statusOutput', `DataSyncManager: ${typeof dataSyncManager}`, 'info');
            log('statusOutput', `AppInitializer: ${typeof appInitializer}`, 'info');
            log('statusOutput', `DB Connected: ${dataSyncManager.dbAvailable}`, 'info');
            log('statusOutput', `App Ready: ${appInitializer.ready}`, 'info');
            log('statusOutput', `LocalStorage Available: ${typeof localStorage !== 'undefined'}`, 'info');
        }

        // Tests de chargement
        async function testLoadManuels() {
            clear('loadOutput');
            log('loadOutput', 'üì• Chargement des manuels...', 'info');
            try {
                const data = await dataSyncManager.load('manuels');
                log('loadOutput', `‚úÖ ${data.length} manuels charg√©s`, 'success');
                log('loadOutput', JSON.stringify(data.slice(0, 2), null, 2), 'info');
            } catch (e) {
                log('loadOutput', `‚ùå Erreur: ${e.message}`, 'error');
            }
        }

        async function testLoadGrades() {
            clear('loadOutput');
            log('loadOutput', 'üì• Chargement des grades...', 'info');
            try {
                const data = await dataSyncManager.load('grades');
                log('loadOutput', `‚úÖ ${data.length} grades charg√©s`, 'success');
            } catch (e) {
                log('loadOutput', `‚ùå Erreur: ${e.message}`, 'error');
            }
        }

        async function testLoadSpecialites() {
            clear('loadOutput');
            log('loadOutput', 'üì• Chargement des sp√©cialit√©s...', 'info');
            try {
                const data = await dataSyncManager.load('specialites');
                log('loadOutput', `‚úÖ ${data.length} sp√©cialit√©s charg√©es`, 'success');
            } catch (e) {
                log('loadOutput', `‚ùå Erreur: ${e.message}`, 'error');
            }
        }

        async function testLoadCategories() {
            clear('loadOutput');
            log('loadOutput', 'üì• Chargement des cat√©gories...', 'info');
            try {
                const data = await dataSyncManager.load('categories');
                log('loadOutput', `‚úÖ ${data.length} cat√©gories charg√©es`, 'success');
            } catch (e) {
                log('loadOutput', `‚ùå Erreur: ${e.message}`, 'error');
            }
        }

        async function testLoadBlippers() {
            clear('loadOutput');
            log('loadOutput', 'üì• Chargement des blippers...', 'info');
            try {
                const data = await dataSyncManager.load('blippers');
                log('loadOutput', `‚úÖ ${data.length} blippers charg√©s`, 'success');
            } catch (e) {
                log('loadOutput', `‚ùå Erreur: ${e.message}`, 'error');
            }
        }

        async function testLoadAll() {
            clear('loadOutput');
            log('loadOutput', 'üì• Chargement de TOUTES les donn√©es...', 'info');
            const results = await appInitializer.importAllData();
            Object.entries(results).forEach(([type, result]) => {
                if (result.success) {
                    log('loadOutput', `‚úÖ ${type}: ${result.count} √©l√©ments`, 'success');
                } else {
                    log('loadOutput', `‚ùå ${type}: ${result.error}`, 'error');
                }
            });
        }

        // Tests de sauvegarde
        async function testSaveManuels() {
            clear('saveOutput');
            log('saveOutput', 'üíæ Test de sauvegarde...', 'info');
            const testData = [
                { title: 'Test Manuel', desc: 'Description test', link: 'http://test.com', importance: 5, categorie: 'Test', catColor: '#ff0000', auteur: 'Test' }
            ];
            try {
                const result = await dataSyncManager.save('manuels', testData);
                log('saveOutput', `‚úÖ Sauvegard√© dans: ${result.savedTo.join(', ')}`, 'success');
                log('saveOutput', JSON.stringify(result, null, 2), 'info');
            } catch (e) {
                log('saveOutput', `‚ùå Erreur: ${e.message}`, 'error');
            }
        }

        async function testSaveToAllSources() {
            clear('saveOutput');
            log('saveOutput', 'üíæ Test sauvegarde multi-source...', 'info');
            const testData = { id: 1, name: 'Test', test: true };
            try {
                const result = await dataSyncManager.save('test-data', testData);
                log('saveOutput', `‚úÖ Sauvegard√© partout: ${result.savedTo.join(', ')}`, 'success');
            } catch (e) {
                log('saveOutput', `‚ùå Erreur: ${e.message}`, 'error');
            }
        }

        function testLocalStorage() {
            clear('saveOutput');
            log('saveOutput', 'üíæ Test LocalStorage...', 'info');
            const data = { test: 'data', timestamp: new Date().toISOString() };
            try {
                localStorage.setItem('test_data', JSON.stringify(data));
                const retrieved = JSON.parse(localStorage.getItem('test_data'));
                log('saveOutput', `‚úÖ LocalStorage OK`, 'success');
                log('saveOutput', JSON.stringify(retrieved, null, 2), 'info');
            } catch (e) {
                log('saveOutput', `‚ùå LocalStorage Error: ${e.message}`, 'error');
            }
        }

        function clearAllCache() {
            if (confirm('√ätes-vous s√ªr? Cela effacera tout le cache localStorage.')) {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('sams_')) localStorage.removeItem(key);
                });
                dataSyncManager.cache = {};
                clear('saveOutput');
                log('saveOutput', 'üóëÔ∏è Cache effac√©', 'warning');
            }
        }

        // Cache
        function viewCache() {
            clear('cacheOutput');
            log('cacheOutput', 'üß† Contenu du Cache:', 'info');
            Object.entries(dataSyncManager.cache).forEach(([key, value]) => {
                const size = Array.isArray(value) ? value.length : Object.keys(value).length;
                log('cacheOutput', `${key}: ${size} items`, 'info');
            });
        }

        function viewLocalStorage() {
            clear('cacheOutput');
            log('cacheOutput', 'üíæ LocalStorage SAMS:', 'info');
            Object.keys(localStorage).filter(k => k.startsWith('sams_')).forEach(key => {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    const size = Array.isArray(data) ? data.length : Object.keys(data).length;
                    log('cacheOutput', `${key}: ${size} items`, 'info');
                } catch (e) {
                    log('cacheOutput', `${key}: Erreur parsing`, 'error');
                }
            });
        }

        async function benchmarkLoad() {
            clear('cacheOutput');
            log('cacheOutput', '‚ö° Benchmark Load...', 'info');
            
            const types = ['manuels', 'grades', 'specialites', 'categories', 'blippers'];
            for (const type of types) {
                const start = performance.now();
                await dataSyncManager.load(type);
                const time = (performance.now() - start).toFixed(2);
                log('cacheOutput', `${type}: ${time}ms`, 'success');
            }
        }

        // BDD Tests
        async function testDBConnection() {
            clear('dbOutput');
            log('dbOutput', 'üîå Test connexion BDD...', 'info');
            try {
                const response = await fetch('api/db.php?action=check');
                const result = await response.json();
                if (result.connected) {
                    log('dbOutput', '‚úÖ BDD Connect√©e', 'success');
                } else {
                    log('dbOutput', '‚ùå BDD Non disponible', 'warning');
                }
                log('dbOutput', JSON.stringify(result, null, 2), 'info');
            } catch (e) {
                log('dbOutput', `‚ùå Erreur: ${e.message}`, 'error');
            }
        }

        async function testDBLoad() {
            clear('dbOutput');
            log('dbOutput', 'üì• Chargement depuis BDD...', 'info');
            try {
                const response = await fetch('api/db.php?action=load&type=manuels');
                const result = await response.json();
                if (result.success) {
                    log('dbOutput', `‚úÖ ${result.data.length} items charg√©s de la BDD`, 'success');
                } else {
                    log('dbOutput', `‚ö†Ô∏è ${result.error}`, 'warning');
                }
            } catch (e) {
                log('dbOutput', `‚ùå Erreur: ${e.message}`, 'error');
            }
        }

        async function testDBSave() {
            clear('dbOutput');
            log('dbOutput', 'üíæ Test sauvegarde BDD...', 'info');
            const testData = [{ id: 'test', label: 'Test', icon: 'üìå', color: '#ff0000' }];
            try {
                const response = await fetch('api/db.php?action=save&type=blippers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                const result = await response.json();
                log('dbOutput', result.success ? '‚úÖ Sauvegard√©' : '‚ùå Erreur', 'info');
                log('dbOutput', JSON.stringify(result, null, 2), 'info');
            } catch (e) {
                log('dbOutput', `‚ùå Erreur: ${e.message}`, 'error');
            }
        }

        // JSON Tests
        async function testJSONFiles() {
            clear('jsonOutput');
            log('jsonOutput', 'üìÑ V√©rification des fichiers JSON...', 'info');
            const files = ['manuels', 'grades', 'specialites', 'categories', 'blippers'];
            for (const file of files) {
                try {
                    const response = await fetch(`json/${file}.json`);
                    if (response.ok) {
                        const data = await response.json();
                        const count = Array.isArray(data) ? data.length : Object.keys(data).length;
                        log('jsonOutput', `‚úÖ ${file}.json: ${count} items`, 'success');
                    } else {
                        log('jsonOutput', `‚ùå ${file}.json: Not found`, 'error');
                    }
                } catch (e) {
                    log('jsonOutput', `‚ùå ${file}.json: ${e.message}`, 'error');
                }
            }
        }

        async function loadJSONDirect() {
            clear('jsonOutput');
            log('jsonOutput', 'üìÑ Chargement JSON Direct...', 'info');
            try {
                const response = await fetch('json/blippers.json');
                const data = await response.json();
                log('jsonOutput', `‚úÖ ${data.length} blippers charg√©s`, 'success');
                log('jsonOutput', JSON.stringify(data.slice(0, 1), null, 2), 'info');
            } catch (e) {
                log('jsonOutput', `‚ùå Erreur: ${e.message}`, 'error');
            }
        }

        // Init
        window.addEventListener('appReady', () => {
            document.getElementById('initStatus').innerHTML = '<span class="status status-ok">‚úÖ Initialis√©e</span>';
        });

        // Auto-check on load
        window.addEventListener('load', async () => {
            await new Promise(r => setTimeout(r, 1000));
            document.getElementById('dbStatus').innerHTML = dataSyncManager.dbAvailable 
                ? '<span class="status status-ok">‚úÖ BDD OK</span>'
                : '<span class="status status-error">‚ùå BDD Down</span>';
        });
    </script>
</body>
</html>
