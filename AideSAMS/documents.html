<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documents MÃ©dicaux - Aide SAMS</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/documents.css">
    <script src="update-notifier.js"></script>
    <script src="background-randomizer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
    <div id="header-placeholder"></div>
    <div id="navbar-placeholder"></div>

    <div class="container">
        <div class="page-header">
            <h1>ğŸ“„ Documents MÃ©dicaux</h1>
        </div>

        <div class="templates-grid">
            <div class="template-card" onclick="createDocument('arret-travail')">
                <div class="template-icon">ğŸ©º</div>
                <div class="template-info">
                    <h3>Avis d'ArrÃªt de Travail</h3>
                    <p>Document officiel d'arrÃªt maladie avec signature du mÃ©decin</p>
                    <div class="template-features">
                        <span class="feature">âœ“ Informations patient</span>
                        <span class="feature">âœ“ DÃ©tails mÃ©dicaux</span>
                        <span class="feature">âœ“ Signature numÃ©rique</span>
                    </div>
                </div>
                <div class="template-action">
                    <button class="btn-template">CrÃ©er un arrÃªt</button>
                </div>
            </div>

            <div class="template-card" onclick="createDocument('certificat-naissance')">
                <div class="template-icon">ğŸ‘¶</div>
                <div class="template-info">
                    <h3>Certificat de Naissance</h3>
                    <p>Certificat mÃ©dical de naissance avec signatures des parents</p>
                    <div class="template-features">
                        <span class="feature">âœ“ DonnÃ©es de l'enfant</span>
                        <span class="feature">âœ“ Informations parents</span>
                        <span class="feature">âœ“ Signatures multiples</span>
                    </div>
                </div>
                <div class="template-action">
                    <button class="btn-template">CrÃ©er un certificat</button>
                </div>
            </div>

            <div class="template-card" onclick="createDocument('facture-hospitalisation')">
                <div class="template-icon">ğŸ¥</div>
                <div class="template-info">
                    <h3>Facture d'Hospitalisation</h3>
                    <p>Facture dÃ©taillÃ©e des frais mÃ©dicaux et hospitaliers</p>
                    <div class="template-features">
                        <span class="feature">âœ“ DÃ©tails des soins</span>
                        <span class="feature">âœ“ Calculs automatiques</span>
                        <span class="feature">âœ“ Export professionnel</span>
                    </div>
                </div>
                <div class="template-action">
                    <button class="btn-template">CrÃ©er une facture</button>
                </div>
            </div>
        </div>

        <!-- Section Brouillons -->
        <div class="drafts-section" id="drafts-section" style="display: none;">
            <h2>ğŸ“ Brouillons SauvegardÃ©s</h2>
            <div class="drafts-grid" id="drafts-grid">
                <!-- Les brouillons seront ajoutÃ©s ici dynamiquement -->
            </div>
        </div>
    </div>

    <script src="js/sams-common.js"></script>
    <script src="js/document-manager.js"></script>
    <script src="js/document-templates.js"></script>
    <script>
        function createDocument(type) {
            console.log('createDocument appelÃ© avec type:', type);
            console.log('documentManager disponible:', !!window.documentManager);
            
            // Navigation directe vers les formulaires de crÃ©ation
            if (window.documentManager) {
                console.log('Utilisation de documentManager.showDocumentForm');
                window.documentManager.showDocumentForm(type);
            } else {
                console.log('Fallback vers rechargement de page');
                // Fallback avec rechargement de page
                window.location.href = `documents.html?create=${type}`;
            }
        }

        
        function regenerateDocument(docId) {
            console.log('RÃ©gÃ©nÃ©ration demandÃ©e pour docId:', docId);
            const history = JSON.parse(localStorage.getItem('documentHistory') || '[]');
            const doc = history.find(d => d.id == docId);
            
            if (!doc) {
                console.error('Document non trouvÃ©, docId:', docId, 'historique:', history);
                alert('âŒ Document introuvable dans l\'historique');
                return;
            }
            
            console.log('Document trouvÃ©:', doc);
            
            // VÃ©rifier que jsPDF est disponible
            if (!window.jspdf || !window.jspdf.jsPDF) {
                alert('âŒ jsPDF non disponible. Rechargez la page.');
                return;
            }
            
            try {
                // RecrÃ©er le PDF avec les donnÃ©es sauvegardÃ©es
                const doc_pdf = new window.jspdf.jsPDF();
                
                // Titre simple pour test
                doc_pdf.setFontSize(20);
                doc_pdf.text('Document RÃ©gÃ©nÃ©rÃ©', 20, 30);
                doc_pdf.setFontSize(12);
                doc_pdf.text(`Type: ${doc.type}`, 20, 50);
                doc_pdf.text(`CrÃ©Ã© le: ${new Date(doc.createdAt).toLocaleString('fr-FR')}`, 20, 70);
                doc_pdf.text(`DonnÃ©es: ${Object.keys(doc.data || {}).length} champs`, 20, 90);
                
                // Sauvegarder
                const newFilename = `regenere_${doc.filename}`;
                doc_pdf.save(newFilename);
                
                alert('âœ… PDF rÃ©gÃ©nÃ©rÃ© avec succÃ¨s !');
                
            } catch (error) {
                console.error('Erreur lors de la rÃ©gÃ©nÃ©ration:', error);
                alert(`âŒ Erreur lors de la rÃ©gÃ©nÃ©ration: ${error.message}`);
            }
        }

        function regenerateDocument(docId) {
            console.log('Tentative de rÃ©gÃ©nÃ©ration du document:', docId);
            
            const history = JSON.parse(localStorage.getItem('documentHistory') || '[]');
            const doc = history.find(d => d.id === docId);
            
            if (!doc) {
                console.error('Document non trouvÃ© dans l\'historique:', docId);
                alert('Document introuvable dans l\'historique');
                return;
            }

            console.log('Document trouvÃ©:', doc);

            // VÃ©rifier la disponibilitÃ© de jsPDF
            if (typeof window.jspdf === 'undefined' && typeof jsPDF === 'undefined') {
                console.error('jsPDF non disponible');
                alert('Erreur : SystÃ¨me PDF non disponible');
                return;
            }

            try {
                // RÃ©gÃ©nÃ©rer le PDF avec les donnÃ©es stockÃ©es
                const { jsPDF } = window.jspdf || window;
                const pdf = new jsPDF();
                
                // Ajouter le contenu du document
                pdf.text(`Document: ${doc.filename}`, 20, 20);
                pdf.text(`Type: ${doc.type}`, 20, 40);
                pdf.text(`CrÃ©Ã© le: ${new Date(doc.createdAt).toLocaleString('fr-FR')}`, 20, 60);
                
                // Si on a les donnÃ©es du formulaire, les ajouter
                if (doc.formData) {
                    let y = 80;
                    Object.entries(doc.formData).forEach(([key, value]) => {
                        if (value && key !== 'signature') {
                            pdf.text(`${key}: ${value}`, 20, y);
                            y += 20;
                        }
                    });
                }
                
                // TÃ©lÃ©charger le PDF
                pdf.save(doc.filename || `document-${doc.id}.pdf`);
                console.log('PDF rÃ©gÃ©nÃ©rÃ© avec succÃ¨s');
                
            } catch (error) {
                console.error('Erreur lors de la rÃ©gÃ©nÃ©ration:', error);
                alert('Erreur lors de la gÃ©nÃ©ration du PDF : ' + error.message);
            }
        }

        function downloadDocument(docId) {
            const history = JSON.parse(localStorage.getItem('documentHistory') || '[]');
            const doc = history.find(d => d.id === docId);
            
            if (!doc) {
                alert('Document introuvable');
                return;
            }
            
            // TÃ©lÃ©charger les donnÃ©es du document en JSON
            const blob = new Blob([JSON.stringify(doc, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${(doc.filename || 'document').replace(/[^a-z0-9]/gi, '_')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialisation du gestionnaire de documents
        let documentManager;
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initialisation du DocumentManager...');
            documentManager = new DocumentManager();
            window.documentManager = documentManager;
            console.log('DocumentManager crÃ©Ã©:', !!window.documentManager);
            
            // Charger les brouillons si ils existent
            loadDraftsOnStartup();
        });

        function loadDraftsOnStartup() {
            const drafts = JSON.parse(localStorage.getItem('documentDrafts') || '[]');
            const section = document.getElementById('drafts-section');
            
            // Si la section n'existe pas (on n'est pas sur la page d'accueil), sortir
            if (!section) {
                return;
            }
            
            if (drafts.length > 0) {
                section.style.display = 'block';
                renderDrafts(drafts);
            }
        }

        function renderDrafts(drafts) {
            const grid = document.getElementById('drafts-grid');
            grid.innerHTML = drafts.map(draft => `
                <div class="draft-card">
                    <div class="draft-header">
                        <h3>${getDocumentTypeIcon(draft.type)} ${draft.title}</h3>
                    </div>
                    <div class="draft-actions">
                        <button class="btn-sm" onclick="continueDraft('${draft.id}')">âœï¸ Continuer</button>
                        <button class="btn-sm" onclick="deleteDraft('${draft.id}')">ğŸ—‘ï¸ Supprimer</button>
                    </div>
                </div>
            `).join('');
        }

        function getDocumentTypeIcon(type) {
            switch(type) {
                case 'arret-travail': return 'ğŸ©º';
                case 'certificat-naissance': return 'ğŸ‘¶';
                case 'facture-hospitalisation': return 'ğŸ¥';
                default: return 'ğŸ“„';
            }
        }

        function continueDraft(draftId) {
            const drafts = JSON.parse(localStorage.getItem('documentDrafts') || '[]');
            const draft = drafts.find(d => d.id == draftId);
            
            if (!draft) {
                alert('âŒ Brouillon non trouvÃ©');
                return;
            }
            
            // Rediriger vers le formulaire avec les donnÃ©es du brouillon
            const params = new URLSearchParams({
                create: draft.type,
                draft: draftId
            });
            window.location.href = `documents.html?${params.toString()}`;
        }

        function deleteDraft(draftId) {
            if (!confirm('ÃŠtes-vous sÃ»r de vouloir supprimer ce brouillon ?')) return;
            
            const drafts = JSON.parse(localStorage.getItem('documentDrafts') || '[]');
            const updatedDrafts = drafts.filter(d => d.id != draftId);
            localStorage.setItem('documentDrafts', JSON.stringify(updatedDrafts));
            
            if (updatedDrafts.length === 0) {
                document.getElementById('drafts-section').style.display = 'none';
            } else {
                renderDrafts(updatedDrafts);
            }
        }
    </script>
</body>

</html>
